name: CI

on:
  push:
  pull_request:

jobs:
  go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Build
        run: cd go && go build ./...
      - name: Vet
        run: cd go && go vet ./...
      - name: Test
        run: cd go && go test -race ./...

  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install deps
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd python && uv sync
      - name: Test
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd python && uv run pytest tests/ -q

  bash:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Install bats
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local
      - name: Test guards
        run: bash tests/test-guards.sh
      - name: Test nudge
        run: bash tests/test-nudge.sh
      - name: Test config
        run: bash tests/test-config.sh

  conformance:
    runs-on: ubuntu-latest
    needs: [go, python, bash]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install bats
        run: |
          git clone --depth 1 https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local
      - name: Run conformance tests
        run: |
          export PATH="$HOME/.cargo/bin:$PATH"
          cd python && uv sync
          cd ..
          bash tests/runners/run_bash.sh
          bash tests/runners/run_go.sh
          bash tests/runners/run_python.sh
